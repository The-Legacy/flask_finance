{% extends "base.html" %}

{% block title %}Accounts - Personal Finance Tracker{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1><i class="bi bi-bank"></i> Account Management</h1>
            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addAccountModal">
                <i class="bi bi-plus-circle"></i> Add Account
            </button>
        </div>
    </div>
</div>

<!-- Summary Cards -->
<div class="row mb-4">
    <div class="col-md-4 mb-3">
        <div class="card bg-primary text-white">
            <div class="card-body text-center">
                <h6>Total Assets</h6>
                <h3>${{ "%.2f"|format(checking_total + savings_total + investment_total + cash_total) }}</h3>
                <small>Checking + Savings + Investments + Cash</small>
            </div>
        </div>
    </div>
    
    <div class="col-md-4 mb-3">
        <div class="card bg-danger text-white">
            <div class="card-body text-center">
                <h6>Total Liabilities</h6>
                <h3>${{ "%.2f"|format(credit_total) }}</h3>
                <small>Credit Cards + Loans</small>
            </div>
        </div>
    </div>
    
    <div class="col-md-4 mb-3">
        <div class="card {% if account_net_worth >= 0 %}bg-success{% else %}bg-warning{% endif %} text-white">
            <div class="card-body text-center">
                <h6>Account Net Worth</h6>
                <h3>${{ "%.2f"|format(account_net_worth) }}</h3>
                <small>Assets - Liabilities</small>
            </div>
        </div>
    </div>
</div>

<!-- Reconciliation Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header {% if reconciliation_difference|abs < 0.01 %}bg-success{% else %}bg-warning{% endif %} text-white">
                <h5 class="card-title mb-0">
                    <i class="bi bi-calculator"></i> Balance Reconciliation
                    {% if reconciliation_difference|abs < 0.01 %}
                        <i class="bi bi-check-circle-fill ms-2"></i>
                    {% else %}
                        <i class="bi bi-exclamation-triangle-fill ms-2"></i>
                    {% endif %}
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 text-center">
                        <h6>Transaction-Based</h6>
                        <h4 class="text-info">${{ "%.2f"|format(calculated_net) }}</h4>
                        <small class="text-muted">Income ({{ "${:,.0f}".format(total_income) }}) - Expenses ({{ "${:,.0f}".format(total_expenses) }})</small>
                    </div>
                    <div class="col-md-3 text-center">
                        <h6>Account-Based</h6>
                        <h4 class="text-primary">${{ "%.2f"|format(account_net_worth) }}</h4>
                        <small class="text-muted">Sum of all account balances</small>
                    </div>
                    <div class="col-md-3 text-center">
                        <h6>Difference</h6>
                        <h4 class="{% if reconciliation_difference|abs < 0.01 %}text-success{% elif reconciliation_difference > 0 %}text-warning{% else %}text-danger{% endif %}">
                            {% if reconciliation_difference > 0 %}+{% endif %}${{ "%.2f"|format(reconciliation_difference) }}
                        </h4>
                        <small class="text-muted">Account vs Transaction totals</small>
                    </div>
                    <div class="col-md-3 text-center">
                        <h6>Status</h6>
                        {% if reconciliation_difference|abs < 0.01 %}
                            <h4 class="text-success">✓ Balanced</h4>
                            <small class="text-success">Accounts match transactions</small>
                        {% else %}
                            <h4 class="text-warning">⚠ Unbalanced</h4>
                            <small class="text-muted">Review account balances</small>
                        {% endif %}
                    </div>
                </div>
                
                {% if reconciliation_difference|abs >= 0.01 %}
                <div class="alert alert-info mt-3">
                    <h6><i class="bi bi-info-circle"></i> Reconciliation Tips</h6>
                    <ul class="mb-0">
                        <li>Check if all transactions are categorized correctly</li>
                        <li>Verify current account balances are up to date</li>
                        <li>Look for pending transactions or bank fees</li>
                        <li>Consider opening balances when accounts were first added</li>
                    </ul>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Account Breakdown by Type -->
<div class="row mb-4">
    <div class="col-md-2 mb-3">
        <div class="card border-primary">
            <div class="card-body text-center">
                <h6 class="text-primary">Checking</h6>
                <h4>${{ "%.0f"|format(checking_total) }}</h4>
            </div>
        </div>
    </div>
    <div class="col-md-2 mb-3">
        <div class="card border-success">
            <div class="card-body text-center">
                <h6 class="text-success">Savings</h6>
                <h4>${{ "%.0f"|format(savings_total) }}</h4>
            </div>
        </div>
    </div>
    <div class="col-md-2 mb-3">
        <div class="card border-info">
            <div class="card-body text-center">
                <h6 class="text-info">Investments</h6>
                <h4>${{ "%.0f"|format(investment_total) }}</h4>
            </div>
        </div>
    </div>
    <div class="col-md-2 mb-3">
        <div class="card border-warning">
            <div class="card-body text-center">
                <h6 class="text-warning">Cash</h6>
                <h4>${{ "%.0f"|format(cash_total) }}</h4>
            </div>
        </div>
    </div>
    <div class="col-md-2 mb-3">
        <div class="card border-danger">
            <div class="card-body text-center">
                <h6 class="text-danger">Credit/Loans</h6>
                <h4>${{ "%.0f"|format(credit_total) }}</h4>
            </div>
        </div>
    </div>
    <div class="col-md-2 mb-3">
        <div class="card border-dark">
            <div class="card-body text-center">
                <h6>Total Accounts</h6>
                <h4>{{ accounts|length }}</h4>
            </div>
        </div>
    </div>
</div>

<!-- Accounts List -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Account Details</h5>
            </div>
            <div class="card-body">
                {% if accounts %}
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Account Name</th>
                                    <th>Type</th>
                                    <th>Bank/Institution</th>
                                    <th>Account #</th>
                                    <th class="text-end">Current Balance</th>
                                    <th class="text-end">Calculated Balance</th>
                                    <th class="text-center">Status</th>
                                    <th class="text-center">Transactions</th>
                                    <th class="text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for account in accounts %}
                                <tr>
                                    <td>
                                        <strong>{{ account.name }}</strong>
                                    </td>
                                    <td>
                                        <span class="badge 
                                            {% if account.account_type == 'checking' %}bg-primary
                                            {% elif account.account_type == 'savings' %}bg-success
                                            {% elif account.account_type == 'credit' %}bg-danger
                                            {% elif account.account_type == 'investment' %}bg-info
                                            {% elif account.account_type == 'cash' %}bg-warning
                                            {% else %}bg-secondary{% endif %}">
                                            {{ account.account_type.title() }}
                                        </span>
                                    </td>
                                    <td>{{ account.bank_name or '-' }}</td>
                                    <td>{{ account.account_number or '-' }}</td>
                                    <td class="text-end">
                                        <strong>${{ "%.2f"|format(account.current_balance) }}</strong>
                                    </td>
                                    <td class="text-end">
                                        ${{ "%.2f"|format(account.get_calculated_balance()) }}
                                    </td>
                                    <td class="text-center">
                                        {% if account.is_balanced() %}
                                            <span class="badge bg-success">Balanced</span>
                                        {% else %}
                                            <span class="badge bg-warning">
                                                {% if account.get_balance_difference() > 0 %}+{% endif %}${{ "%.2f"|format(account.get_balance_difference()) }}
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        <span class="badge bg-info">{{ account.get_transaction_count() }}</span>
                                    </td>
                                    <td class="text-center">
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-primary btn-sm" 
                                                    data-bs-toggle="modal" 
                                                    data-bs-target="#updateBalanceModal"
                                                    data-account-id="{{ account.id }}"
                                                    data-account-name="{{ account.name }}"
                                                    data-current-balance="{{ account.current_balance }}">
                                                <i class="bi bi-pencil"></i>
                                            </button>
                                            <form method="POST" action="{{ url_for('delete_account', account_id=account.id) }}" class="d-inline" 
                                                  onsubmit="return confirm('Are you sure you want to delete this account?')">
                                                <button type="submit" class="btn btn-outline-danger btn-sm">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </form>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center py-5">
                        <i class="bi bi-bank display-1 text-muted"></i>
                        <h4 class="text-muted mt-3">No accounts added yet</h4>
                        <p class="text-muted">Start tracking your finances by adding your first account.</p>
                        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addAccountModal">
                            <i class="bi bi-plus-circle"></i> Add Your First Account
                        </button>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Unbalanced Accounts Alert -->
{% if unbalanced_accounts %}
<div class="row mt-4">
    <div class="col-12">
        <div class="alert alert-warning">
            <h6><i class="bi bi-exclamation-triangle"></i> Unbalanced Accounts Detected</h6>
            <p class="mb-2">The following accounts have discrepancies between actual and calculated balances:</p>
            <div class="row">
                {% for account in unbalanced_accounts %}
                <div class="col-md-4 mb-2">
                    <span class="badge bg-warning text-dark me-2">{{ account.name }}</span>
                    <strong>
                        {% if account.get_balance_difference() > 0 %}+{% endif %}${{ "%.2f"|format(account.get_balance_difference()) }}
                    </strong>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Add Account Modal -->
<div class="modal fade" id="addAccountModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Account</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('add_account') }}" method="POST">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Account Name *</label>
                        <input type="text" class="form-control" name="name" placeholder="e.g., Chase Checking" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Account Type *</label>
                        <select class="form-select" name="account_type" required>
                            <option value="">Choose account type...</option>
                            <option value="checking">💳 Checking</option>
                            <option value="savings">💰 Savings</option>
                            <option value="credit">💸 Credit Card</option>
                            <option value="investment">📈 Investment</option>
                            <option value="cash">💵 Cash</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Bank/Institution</label>
                        <input type="text" class="form-control" name="bank_name" placeholder="e.g., Chase Bank">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Account Number (Last 4 digits)</label>
                        <input type="text" class="form-control" name="account_number" placeholder="e.g., 1234" maxlength="10">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Current Balance *</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" class="form-control" name="current_balance" step="0.01" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Initial Balance (when account was opened)</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" class="form-control" name="initial_balance" step="0.01" placeholder="Leave blank to use current balance">
                        </div>
                        <small class="text-muted">Used for calculating balance from transaction history</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">Add Account</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Update Balance Modal -->
<div class="modal fade" id="updateBalanceModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Update Account Balance</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('update_account_balance') }}" method="POST">
                <div class="modal-body">
                    <input type="hidden" name="account_id" id="update_account_id">
                    <div class="mb-3">
                        <label class="form-label">Account</label>
                        <input type="text" class="form-control" id="update_account_name" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">New Current Balance *</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" class="form-control" name="current_balance" id="update_current_balance" step="0.01" required>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Balance</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Handle update balance modal
document.addEventListener('DOMContentLoaded', function() {
    const updateBalanceModal = document.getElementById('updateBalanceModal');
    if (updateBalanceModal) {
        updateBalanceModal.addEventListener('show.bs.modal', function(event) {
            const button = event.relatedTarget;
            const accountId = button.getAttribute('data-account-id');
            const accountName = button.getAttribute('data-account-name');
            const currentBalance = button.getAttribute('data-current-balance');
            
            document.getElementById('update_account_id').value = accountId;
            document.getElementById('update_account_name').value = accountName;
            document.getElementById('update_current_balance').value = currentBalance;
        });
    }
});
</script>
{% endblock %}
