{% extends "base.html" %}

{% block title %}Dashboard - Personal Finance Tracker{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1><i class="bi bi-speedometer2"></i> Financial Dashboard</h1>
            <div>
                <a href="{{ url_for('transactions') }}" class="btn btn-outline-primary">
                    <i class="bi bi-list-ul"></i> All Transactions
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Time Frame Selector -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-light">
                <h6 class="card-title mb-0">
                    <i class="bi bi-calendar-range"></i> Time Frame: {{ period_name }}
                </h6>
            </div>
            <div class="card-body">
                <form method="GET" action="{{ url_for('dashboard') }}" class="row g-3 align-items-end">
                    <div class="col-md-3">
                        <label for="time_frame" class="form-label">Select Time Frame</label>
                        <select class="form-select" id="time_frame" name="time_frame" onchange="toggleCustomDates()">
                            <option value="current_month" {% if time_frame == 'current_month' %}selected{% endif %}>Current Month</option>
                            <option value="last_month" {% if time_frame == 'last_month' %}selected{% endif %}>Last Month</option>
                            <option value="last_3_months" {% if time_frame == 'last_3_months' %}selected{% endif %}>Last 3 Months</option>
                            <option value="last_6_months" {% if time_frame == 'last_6_months' %}selected{% endif %}>Last 6 Months</option>
                            <option value="year_to_date" {% if time_frame == 'year_to_date' %}selected{% endif %}>Year to Date</option>
                            <option value="custom" {% if time_frame == 'custom' %}selected{% endif %}>Custom Range</option>
                        </select>
                    </div>
                    <div class="col-md-3" id="custom_start_div" {% if time_frame != 'custom' %}style="display: none;"{% endif %}>
                        <label for="start_date" class="form-label">Start Date</label>
                        <input type="date" class="form-control" id="start_date" name="start_date" value="{{ request.args.get('start_date', '') }}">
                    </div>
                    <div class="col-md-3" id="custom_end_div" {% if time_frame != 'custom' %}style="display: none;"{% endif %}>
                        <label for="end_date" class="form-label">End Date</label>
                        <input type="date" class="form-control" id="end_date" name="end_date" value="{{ request.args.get('end_date', '') }}">
                    </div>
                    <div class="col-md-3">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-search"></i> Update View
                        </button>
                        {% if time_frame != 'current_month' %}
                        <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-counterclockwise"></i> Reset
                        </a>
                        {% endif %}
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Summary Cards -->
<div class="row mb-4">
    <div class="col-md-3 mb-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title">Total Income ({{ period_name }})</h6>
                        <h3 class="mb-0">${{ "%.2f"|format(monthly_income) }}</h3>
                        <small class="opacity-75">
                            Taxable: ${{ "%.2f"|format(monthly_taxable_income) }} | 
                            Non-taxable: ${{ "%.2f"|format(monthly_income - monthly_taxable_income) }}
                        </small>
                    </div>
                    <i class="bi bi-arrow-up-circle fs-1"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="card bg-danger text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title">Total Expenses ({{ period_name }})</h6>
                        <h3 class="mb-0">${{ "%.2f"|format(monthly_expenses) }}</h3>
                    </div>
                    <i class="bi bi-arrow-down-circle fs-1"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="card bg-warning text-dark">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title">Tax Amount ({{ period_name }})</h6>
                        {% if monthly_tax_amount > 0 %}
                            <h3 class="mb-0">${{ "%.2f"|format(monthly_tax_amount) }}</h3>
                        {% else %}
                            <h3 class="mb-0">--</h3>
                        {% endif %}
                    </div>
                    <i class="bi bi-receipt fs-1"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="card {% if monthly_net_balance >= 0 %}bg-info{% else %}bg-secondary{% endif %} text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title">Net Balance</h6>
                        <h3 class="mb-0">${{ "%.2f"|format(monthly_net_balance) }}</h3>
                    </div>
                    <i class="bi bi-wallet2 fs-1"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Budget vs Actual Analysis -->
{% if budget_analysis %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="card-title mb-0">
                    <i class="bi bi-pie-chart"></i> Budget vs Actual Spending - {{ budget_analysis.active_budget.name }}
                    <small class="d-block mt-1 opacity-75">
                        Scaled for {{ budget_analysis.period_name }} 
                        ({{ budget_analysis.days_in_period }} days, {{ "%.1f"|format(budget_analysis.budget_scaling_factor) }}x monthly budget)
                    </small>
                </h5>
            </div>
            <div class="card-body">
                <!-- Budget Summary -->
                <div class="row mb-4">
                    <div class="col-md-4 text-center">
                        <h6>Total Budgeted ({{ budget_analysis.period_name }})</h6>
                        <h4 class="text-primary">${{ "{:,.2f}".format(budget_analysis.total_budgeted) }}</h4>
                        {% if budget_analysis.budget_scaling_factor != 1.0 %}
                        <small class="text-muted">Monthly: ${{ "{:,.2f}".format(budget_analysis.monthly_total_budgeted) }}</small>
                        {% endif %}
                    </div>
                    <div class="col-md-4 text-center">
                        <h6>Total Spent</h6>
                        <h4 class="{% if budget_analysis.total_spent > budget_analysis.total_budgeted %}text-danger{% else %}text-success{% endif %}">
                            ${{ "{:,.2f}".format(budget_analysis.total_spent) }}
                        </h4>
                    </div>
                    <div class="col-md-4 text-center">
                        <h6>Remaining Budget</h6>
                        <h4 class="{% if budget_analysis.budget_remaining < 0 %}text-danger{% else %}text-success{% endif %}">
                            ${{ "{:,.2f}".format(budget_analysis.budget_remaining) }}
                        </h4>
                    </div>
                </div>
                
                <!-- Category Breakdown -->
                <div class="row">
                    {% for category, data in budget_analysis.budget_vs_actual.items() %}
                    {% if data.budget > 0 %}
                    <div class="col-md-6 col-lg-4 mb-3">
                        <div class="card">
                            <div class="card-body">
                                <h6 class="card-title">{{ category }}</h6>
                                <div class="progress mb-2" style="height: 10px;">
                                    <div class="progress-bar {% if data.percentage_used > 100 %}bg-danger{% elif data.percentage_used > 80 %}bg-warning{% else %}bg-success{% endif %}" 
                                         role="progressbar" 
                                         style="width: {{ data.percentage_used|round(1) }}%"
                                         aria-valuenow="{{ data.percentage_used|round(1) }}" 
                                         aria-valuemin="0" 
                                         aria-valuemax="100">
                                    </div>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <small>Spent: ${{ "{:,.0f}".format(data.actual) }}</small>
                                    <small>Budget: ${{ "{:,.0f}".format(data.budget) }}</small>
                                </div>
                                {% if budget_analysis.budget_scaling_factor != 1.0 %}
                                <div class="text-center">
                                    <small class="text-muted">Monthly budget: ${{ "{:,.0f}".format(data.monthly_budget) }}</small>
                                </div>
                                {% endif %}
                                <div class="text-center mt-1">
                                    <small class="{% if data.remaining < 0 %}text-danger{% else %}text-success{% endif %}">
                                        {% if data.remaining >= 0 %}
                                            ${{ "{:,.0f}".format(data.remaining) }} remaining
                                        {% else %}
                                            ${{ "{:,.0f}".format(-data.remaining) }} over budget
                                        {% endif %}
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
                
                <!-- Unmapped Spending Alert -->
                {% if budget_analysis.total_unmapped > 0 %}
                <div class="alert alert-warning mt-4">
                    <h6><i class="bi bi-exclamation-triangle"></i> Unmapped Spending Detected</h6>
                    <p class="mb-2">The following spending categories aren't tracked against your budget:</p>
                    <div class="row">
                        {% for category, amount in budget_analysis.unmapped_spending.items() %}
                        <div class="col-md-4 mb-2">
                            <span class="badge bg-warning text-dark me-2">{{ category }}</span>
                            <strong>${{ "{:,.0f}".format(amount) }}</strong>
                        </div>
                        {% endfor %}
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between align-items-center">
                        <span><strong>Total Unmapped: ${{ "{:,.0f}".format(budget_analysis.total_unmapped) }}</strong></span>
                        <small class="text-muted">Consider updating your budget categories or transaction categories for better tracking</small>
                    </div>
                </div>
                {% endif %}
                
                <!-- Overall Budget Progress Bar -->
                {% if budget_analysis.total_budgeted > 0 %}
                <div class="mt-4 mb-3">
                    {% set budget_percentage = ((budget_analysis.total_spent / budget_analysis.total_budgeted) * 100) | round(1) %}
                    {% if budget_percentage <= 80 %}
                        {% set progress_color = "success" %}
                        {% set progress_text_color = "text-success" %}
                        {% set status_icon = "check-circle" %}
                        {% set status_text = "On Track" %}
                    {% elif budget_percentage <= 100 %}
                        {% set progress_color = "warning" %}
                        {% set progress_text_color = "text-warning" %}
                        {% set status_icon = "exclamation-triangle" %}
                        {% set status_text = "Close to Limit" %}
                    {% else %}
                        {% set progress_color = "danger" %}
                        {% set progress_text_color = "text-danger" %}
                        {% set status_icon = "x-circle" %}
                        {% set status_text = "Over Budget" %}
                    {% endif %}
                    
                    <h6 class="mb-2">
                        <i class="bi bi-bar-chart"></i> Overall Budget Status 
                        <span class="{{ progress_text_color }} ms-2">
                            <i class="bi bi-{{ status_icon }}"></i> {{ status_text }}
                        </span>
                    </h6>
                    
                    <div class="progress mb-2" style="height: 20px;">
                        <div class="progress-bar bg-{{ progress_color }}" 
                             role="progressbar" 
                             style="width: {{ [budget_percentage, 100] | min }}%"
                             aria-valuenow="{{ budget_percentage }}" 
                             aria-valuemin="0" 
                             aria-valuemax="100">
                            {{ budget_percentage }}%
                        </div>
                    </div>
                    
                    <div class="row text-center small">
                        <div class="col-4">
                            <div class="text-success">
                                <i class="bi bi-wallet2"></i><br>
                                <strong>${{ "{:,.0f}".format(budget_analysis.total_budgeted) }}</strong><br>
                                <span class="text-muted">Budgeted</span>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="{{ progress_text_color }}">
                                <i class="bi bi-credit-card"></i><br>
                                <strong>${{ "{:,.0f}".format(budget_analysis.total_spent) }}</strong><br>
                                <span class="text-muted">Spent</span>
                            </div>
                        </div>
                        <div class="col-4">
                            {% set remaining = budget_analysis.total_budgeted - budget_analysis.total_spent %}
                            {% if remaining >= 0 %}
                            <div class="text-success">
                                <i class="bi bi-piggy-bank"></i><br>
                                <strong>${{ "{:,.0f}".format(remaining) }}</strong><br>
                                <span class="text-muted">Remaining</span>
                            </div>
                            {% else %}
                            <div class="text-danger">
                                <i class="bi bi-exclamation-triangle"></i><br>
                                <strong>${{ "{:,.0f}".format(remaining | abs) }}</strong><br>
                                <span class="text-muted">Over Budget</span>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endif %}
                
                <div class="text-center mt-3">
                    <a href="{{ url_for('budget') }}" class="btn btn-outline-primary">
                        <i class="bi bi-pencil"></i> Adjust Budget
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% else %}
<div class="row mb-4">
    <div class="col-12">
        <div class="alert alert-info">
            <h6><i class="bi bi-info-circle"></i> No Budget Plan Found</h6>
            <p class="mb-2">Create a budget plan to track your spending against your financial goals.</p>
            <a href="{{ url_for('budget') }}" class="btn btn-primary">
                <i class="bi bi-plus-circle"></i> Create Budget Plan
            </a>
        </div>
    </div>
</div>
{% endif %}

<!-- Tax Cost Breakdown -->
{% if tax_breakdown %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-warning text-dark">
                <h5 class="card-title mb-0">
                    <i class="bi bi-receipt-cutoff"></i> Estimated Annual Tax Breakdown
                </h5>
            </div>
            <div class="card-body">
                <!-- Tax Summary -->
                <div class="row mb-4">
                    <div class="col-md-3 text-center">
                        <h6>Annual Income</h6>
                        <h4 class="text-primary">${{ "{:,.0f}".format(tax_breakdown.annual_income) }}</h4>
                    </div>
                    <div class="col-md-3 text-center">
                        <h6>Total Annual Taxes</h6>
                        <h4 class="text-danger">${{ "{:,.0f}".format(tax_breakdown.tax_details.total_annual) }}</h4>
                    </div>
                    <div class="col-md-3 text-center">
                        <h6>Monthly Tax Cost</h6>
                        <h4 class="text-warning">${{ "{:,.0f}".format(tax_breakdown.monthly_taxes) }}</h4>
                    </div>
                    <div class="col-md-3 text-center">
                        <h6>Effective Tax Rate</h6>
                        <h4 class="text-info">{{ "{:.1f}".format(tax_breakdown.effective_rate) }}%</h4>
                    </div>
                </div>
                
                <!-- Tax Component Breakdown -->
                <div class="row">
                    <div class="col-md-8">
                        <h6>Tax Components</h6>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <div class="card border-primary">
                                    <div class="card-body p-3">
                                        <h6 class="card-title text-primary">Federal Income Tax</h6>
                                        <h4>${{ "{:,.0f}".format(tax_breakdown.tax_details.federal_income) }}</h4>
                                        <small class="text-muted">
                                            ${{ "{:,.0f}".format(tax_breakdown.tax_details.federal_income / 12) }}/month
                                        </small>
                                    </div>
                                </div>
                            </div>
                            
                            {% if tax_breakdown.tax_details.federal_payroll > 0 %}
                            <div class="col-md-6 mb-3">
                                <div class="card border-info">
                                    <div class="card-body p-3">
                                        <h6 class="card-title text-info">Payroll Taxes (FICA)</h6>
                                        <h4>${{ "{:,.0f}".format(tax_breakdown.tax_details.federal_payroll) }}</h4>
                                        <small class="text-muted">
                                            Social Security & Medicare
                                        </small>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                            
                            {% if tax_breakdown.tax_details.self_employment > 0 %}
                            <div class="col-md-6 mb-3">
                                <div class="card border-success">
                                    <div class="card-body p-3">
                                        <h6 class="card-title text-success">Self-Employment Tax</h6>
                                        <h4>${{ "{:,.0f}".format(tax_breakdown.tax_details.self_employment) }}</h4>
                                        <small class="text-muted">
                                            SS & Medicare for 1099 workers
                                        </small>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                            
                            {% if tax_breakdown.tax_details.state_tax > 0 %}
                            <div class="col-md-6 mb-3">
                                <div class="card border-warning">
                                    <div class="card-body p-3">
                                        <h6 class="card-title text-warning">{{ tax_breakdown.state_name }}</h6>
                                        <h4>${{ "{:,.0f}".format(tax_breakdown.tax_details.state_tax) }}</h4>
                                        <small class="text-muted">
                                            State income tax
                                        </small>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                            
                            {% if tax_breakdown.tax_details.local_tax > 0 %}
                            <div class="col-md-6 mb-3">
                                <div class="card border-secondary">
                                    <div class="card-body p-3">
                                        <h6 class="card-title text-secondary">{{ tax_breakdown.city_name }}</h6>
                                        <h4>${{ "{:,.0f}".format(tax_breakdown.tax_details.local_tax) }}</h4>
                                        <small class="text-muted">
                                            Local income tax
                                        </small>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h6>Tax Planning Tips</h6>
                                <ul class="mb-0 small">
                                    <li>Consider increasing 401(k) contributions to reduce taxable income</li>
                                    <li>Track tax-deductible expenses throughout the year</li>
                                    {% if tax_breakdown.tax_details.self_employment > 0 %}
                                    <li>Make quarterly estimated tax payments to avoid penalties</li>
                                    <li>Track business expenses for deductions</li>
                                    {% endif %}
                                    <li>Review withholding annually or after major life changes</li>
                                </ul>
                                <div class="mt-3">
                                    <a href="{{ url_for('taxes') }}" class="btn btn-sm btn-outline-primary">
                                        <i class="bi bi-calculator"></i> Full Tax Calculator
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Charts Row -->
<div class="row mb-4">
    <div class="col-md-6 mb-3">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Spending by Category</h5>
            </div>
            <div class="card-body">
                <canvas id="spendingChart" width="400" height="400"></canvas>
            </div>
        </div>
    </div>
    
    <div class="col-md-6 mb-3">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Income vs Expenses</h5>
            </div>
            <div class="card-body">
                <canvas id="incomeExpenseChart" width="400" height="400"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Portfolio & Debt Summary -->
<div class="row mb-4">
    <div class="col-md-4 mb-3">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Investment Portfolio</h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6">
                        <h6>Invested</h6>
                        <h5 class="text-primary">${{ "%.2f"|format(total_invested) }}</h5>
                    </div>
                    <div class="col-6">
                        <h6>Current Value</h6>
                        <h5 class="{% if portfolio_gain_loss >= 0 %}text-success{% else %}text-danger{% endif %}">
                            ${{ "%.2f"|format(current_portfolio_value) }}
                        </h5>
                    </div>
                </div>
                <hr>
                <div class="text-center">
                    <h6>Gain/Loss</h6>
                    <h4 class="{% if portfolio_gain_loss >= 0 %}text-success{% else %}text-danger{% endif %}">
                        {% if portfolio_gain_loss >= 0 %}+{% endif %}${{ "%.2f"|format(portfolio_gain_loss) }}
                    </h4>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4 mb-3">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Debt Summary</h5>
            </div>
            <div class="card-body">
                <div class="text-center">
                    <h6>Total Debt</h6>
                    <h4 class="text-danger">${{ "%.2f"|format(total_debt) }}</h4>
                </div>
                <hr>
                {% if loans %}
                    <small class="text-muted">Active Loans: {{ loans|length }}</small>
                {% else %}
                    <p class="text-muted mb-0">No active loans</p>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-md-4 mb-3">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Quick Actions</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#addTransactionModal">
                        <i class="bi bi-plus-circle"></i> Add Transaction
                    </button>
                    <a href="{{ url_for('transactions') }}" class="btn btn-outline-primary btn-sm">
                        <i class="bi bi-list-ul"></i> View All Transactions
                    </a>
                    <a href="{{ url_for('taxes') }}" class="btn btn-outline-info btn-sm">
                        <i class="bi bi-calculator"></i> Tax Calculator
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Transactions for Selected Period -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="bi bi-list-ul"></i> Transactions - {{ period_name }}
                    <small class="text-muted">({{ transactions|length }} transactions)</small>
                </h5>
                <a href="{{ url_for('transactions') }}" class="btn btn-sm btn-outline-primary">
                    <i class="bi bi-search"></i> Advanced Search
                </a>
            </div>
            <div class="card-body">
                {% if transactions %}
                    <!-- Summary row for selected period -->
                    {% set period_transactions_income = transactions|selectattr('transaction_type', 'equalto', 'income')|map(attribute='amount')|sum %}
                    {% set period_transactions_taxable = transactions|selectattr('transaction_type', 'equalto', 'income')|selectattr('is_taxable', 'equalto', true)|map(attribute='amount')|sum %}
                    {% set period_transactions_expenses = transactions|selectattr('transaction_type', 'equalto', 'expense')|map(attribute='amount')|sum %}
                    
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <div class="text-center p-2 bg-success text-white rounded">
                                <small>Total Income</small>
                                <div class="fw-bold">${{ "{:,.2f}".format(period_transactions_income) }}</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center p-2 bg-info text-white rounded">
                                <small>Taxable Income</small>
                                <div class="fw-bold">${{ "{:,.2f}".format(period_transactions_taxable) }}</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center p-2 bg-danger text-white rounded">
                                <small>Total Expenses</small>
                                <div class="fw-bold">${{ "{:,.2f}".format(period_transactions_expenses) }}</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center p-2 {% if period_transactions_income - period_transactions_expenses >= 0 %}bg-primary{% else %}bg-warning{% endif %} text-white rounded">
                                <small>Net Balance</small>
                                <div class="fw-bold">${{ "{:,.2f}".format(period_transactions_income - period_transactions_expenses) }}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Description</th>
                                    <th>Category</th>
                                    <th>Account</th>
                                    <th>Type</th>
                                    <th class="text-end">Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for transaction in transactions %}
                                <tr>
                                    <td>{{ transaction.date.strftime('%m/%d/%Y') }}</td>
                                    <td>{{ transaction.description or '-' }}</td>
                                    <td><span class="badge bg-secondary">{{ transaction.category }}</span></td>
                                    <td>
                                        {% if transaction.account %}
                                            <span class="badge bg-info">{{ transaction.account.name }}</span>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="badge {% if transaction.transaction_type == 'income' %}bg-success{% else %}bg-danger{% endif %}">
                                            {{ transaction.transaction_type.title() }}
                                        </span>
                                        {% if transaction.transaction_type == 'income' %}
                                            {% if transaction.is_taxable %}
                                                <small class="text-muted ms-1" title="Taxable income">üí∞</small>
                                            {% else %}
                                                <small class="text-warning ms-1" title="Non-taxable income (gift, refund, etc.)">üéÅ</small>
                                            {% endif %}
                                        {% endif %}
                                    </td>
                                    <td class="text-end {% if transaction.transaction_type == 'income' %}text-success{% else %}text-danger{% endif %}">
                                        {% if transaction.transaction_type == 'income' %}+{% else %}-{% endif %}${{ "%.2f"|format(transaction.amount) }}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center py-5">
                        <i class="bi bi-inbox display-1 text-muted"></i>
                        <h4 class="text-muted mt-3">No transactions found for {{ period_name }}</h4>
                        <p class="text-muted">Add your first transaction or try a different time period.</p>
                        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addTransactionModal">
                            <i class="bi bi-plus-circle"></i> Add Transaction
                        </button>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Quick Add Transaction Modal -->
<div class="modal fade" id="addTransactionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Transaction</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('add_transaction') }}" method="POST">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Transaction Type *</label>
                        <select class="form-select" name="transaction_type" id="modal_transaction_type" required>
                            <option value="">Choose transaction type...</option>
                            <option value="income">üí∞ Income</option>
                            <option value="expense">üí∏ Expense</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Category *</label>
                        <select class="form-select" name="category" id="modal_category_select" required disabled>
                            <option value="">Select transaction type first...</option>
                        </select>
                        <input type="text" class="form-control mt-2" name="custom_category" id="modal_custom_category" 
                               placeholder="Or enter custom category" style="display: none;">
                        <div class="form-check mt-2" style="display: none;" id="modal_custom_category_check">
                            <input class="form-check-input" type="checkbox" id="modal_use_custom" name="use_custom">
                            <label class="form-check-label" for="modal_use_custom">
                                Use custom category
                            </label>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Account</label>
                        <select class="form-select" name="account_id">
                            <option value="">No specific account</option>
                            {% for account in accounts %}
                            <option value="{{ account.id }}">
                                {{ account.name }} 
                                {% if account.bank_name %}({{ account.bank_name }}){% endif %}
                                - ${{ "%.2f"|format(account.current_balance) }}
                            </option>
                            {% endfor %}
                        </select>
                        <small class="text-muted">Optional: Select which account this transaction affects</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Amount *</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" class="form-control" name="amount" step="0.01" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Date *</label>
                        <input type="date" class="form-control" name="date" value="{{ date.today() }}" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <input type="text" class="form-control" name="description" 
                               placeholder="Optional description">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Transaction</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Define category options (same as in transactions.html)
const categoryOptions = {
    income: [
        'Salary', 'Freelance', 'Business Income', 'Investment Returns', 'Rental Income',
        'Side Hustle', 'Bonus', 'Gift', 'Tax Refund', 'Other Income'
    ],
    expense: [
        'Housing', 'Rent', 'Mortgage', 'Property Tax', 'Home Insurance', 'Home Maintenance',
        'Food & Dining', 'Groceries', 'Restaurants', 'Coffee', 'Takeout',
        'Transportation', 'Gas', 'Car Payment', 'Car Insurance', 'Public Transit', 'Uber/Lyft', 'Car Maintenance',
        'Utilities', 'Electric', 'Gas', 'Water', 'Internet', 'Phone', 'Trash',
        'Healthcare', 'Medical', 'Dental', 'Pharmacy', 'Health Insurance', 'Vision',
        'Entertainment', 'Movies', 'Games', 'Subscriptions', 'Hobbies', 'Sports', 'Books',
        'Shopping', 'Clothing', 'Electronics', 'Online Shopping', 'Home Goods',
        'Personal Care', 'Beauty', 'Haircut', 'Gym', 'Spa',
        'Education', 'Tuition', 'Books', 'Courses', 'Training',
        'Insurance', 'Life Insurance', 'Disability Insurance', 'Umbrella Insurance',
        'Other'
    ]
};

document.addEventListener('DOMContentLoaded', function() {
    // Initialize Bootstrap tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl)
    });

    // Handle modal category selection
    const modalTransactionTypeSelect = document.getElementById('modal_transaction_type');
    const modalCategorySelect = document.getElementById('modal_category_select');
    const modalCustomCategoryInput = document.getElementById('modal_custom_category');
    const modalCustomCategoryCheck = document.getElementById('modal_custom_category_check');
    const modalUseCustomCheckbox = document.getElementById('modal_use_custom');
    
    if (modalTransactionTypeSelect) {
        modalTransactionTypeSelect.addEventListener('change', function() {
            const selectedType = this.value;
            
            // Clear and enable category select
            modalCategorySelect.innerHTML = '<option value="">Choose category...</option>';
            
            if (selectedType && categoryOptions[selectedType]) {
                modalCategorySelect.disabled = false;
                
                // Populate category options
                categoryOptions[selectedType].forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    modalCategorySelect.appendChild(option);
                });
                
                // Show custom category option
                modalCustomCategoryCheck.style.display = 'block';
            } else {
                modalCategorySelect.disabled = true;
                modalCustomCategoryCheck.style.display = 'none';
                modalCustomCategoryInput.style.display = 'none';
            }
        });
        
        // Handle custom category checkbox in modal
        modalUseCustomCheckbox.addEventListener('change', function() {
            if (this.checked) {
                modalCustomCategoryInput.style.display = 'block';
                modalCategorySelect.disabled = true;
                modalCustomCategoryInput.required = true;
                modalCategorySelect.required = false;
            } else {
                modalCustomCategoryInput.style.display = 'none';
                modalCategorySelect.disabled = false;
                modalCustomCategoryInput.required = false;
                modalCategorySelect.required = true;
            }
        });
    }

    // Load spending by category chart
    fetch('/api/chart_data?type=spending_by_category')
        .then(response => response.json())
        .then(data => {
            const ctx = document.getElementById('spendingChart').getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: data.labels,
                    datasets: [{
                        data: data.data,
                        backgroundColor: [
                            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
                            '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        });
    
    // Load income vs expenses chart
    fetch('/api/chart_data?type=income_vs_expenses')
        .then(response => response.json())
        .then(data => {
            const ctx = document.getElementById('incomeExpenseChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: 'Income',
                        data: data.income,
                        backgroundColor: '#28a745'
                    }, {
                        label: 'Expenses',
                        data: data.expenses,
                        backgroundColor: '#dc3545'
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        });
    
    // Function to toggle custom date inputs
    function toggleCustomDates() {
        const timeFrame = document.getElementById('time_frame').value;
        const startDiv = document.getElementById('custom_start_div');
        const endDiv = document.getElementById('custom_end_div');
        
        if (timeFrame === 'custom') {
            startDiv.style.display = 'block';
            endDiv.style.display = 'block';
        } else {
            startDiv.style.display = 'none';
            endDiv.style.display = 'none';
        }
    }
    
    // Set up the toggle function globally
    window.toggleCustomDates = toggleCustomDates;
});
</script>
{% endblock %}
