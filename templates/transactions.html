{% extends "base.html" %}

{% block title %}Transactions - Personal Finance Tracker{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1><i class="bi bi-list-ul"></i> Transactions</h1>
            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addTransactionModal">
                <i class="bi bi-plus-circle"></i> Add Transaction
            </button>
        </div>
    </div>
</div>

<!-- Filter Form -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Filter Transactions</h5>
            </div>
            <div class="card-body">
                <form method="GET" action="{{ url_for('transactions') }}">
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Category</label>
                            <select class="form-select" name="category">
                                <option value="">All Categories</option>
                                {% for category in categories %}
                                    <option value="{{ category }}" {% if current_filters.category == category %}selected{% endif %}>
                                        {{ category }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Type</label>
                            <select class="form-select" name="type">
                                <option value="">All Types</option>
                                <option value="income" {% if current_filters.type == 'income' %}selected{% endif %}>Income</option>
                                <option value="expense" {% if current_filters.type == 'expense' %}selected{% endif %}>Expense</option>
                            </select>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Start Date</label>
                            <input type="date" class="form-control" name="start_date" value="{{ current_filters.start_date }}">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">End Date</label>
                            <input type="date" class="form-control" name="end_date" value="{{ current_filters.end_date }}">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12">
                            <button type="submit" class="btn btn-primary me-2">
                                <i class="bi bi-funnel"></i> Apply Filters
                            </button>
                            <a href="{{ url_for('transactions') }}" class="btn btn-outline-secondary">
                                <i class="bi bi-x-circle"></i> Clear Filters
                            </a>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Transactions Summary -->
{% if transactions %}
<div class="row mb-4">
    <div class="col-md-4 mb-3">
        <div class="card bg-success text-white">
            <div class="card-body text-center">
                <h6>Total Income (Filtered)</h6>
                <h4>${{ "%.2f"|format(transactions|selectattr('transaction_type', 'equalto', 'income')|map(attribute='amount')|sum) }}</h4>
            </div>
        </div>
    </div>
    <div class="col-md-4 mb-3">
        <div class="card bg-danger text-white">
            <div class="card-body text-center">
                <h6>Total Expenses (Filtered)</h6>
                <h4>${{ "%.2f"|format(transactions|selectattr('transaction_type', 'equalto', 'expense')|map(attribute='amount')|sum) }}</h4>
            </div>
        </div>
    </div>
    <div class="col-md-4 mb-3">
        <div class="card bg-info text-white">
            <div class="card-body text-center">
                <h6>Net (Filtered)</h6>
                <h4>${{ "%.2f"|format(transactions|selectattr('transaction_type', 'equalto', 'income')|map(attribute='amount')|sum - transactions|selectattr('transaction_type', 'equalto', 'expense')|map(attribute='amount')|sum) }}</h4>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Transactions Table -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Transaction History</h5>
            </div>
            <div class="card-body">
                {% if transactions %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Description</th>
                                    <th>Category</th>
                                    <th>Account</th>
                                    <th>Type</th>
                                    <th class="text-end">Amount</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for transaction in transactions %}
                                <tr>
                                    <td>{{ transaction.date.strftime('%m/%d/%Y') }}</td>
                                    <td>{{ transaction.description or '-' }}</td>
                                    <td><span class="badge bg-secondary">{{ transaction.category }}</span></td>
                                    <td>
                                        {% if transaction.account %}
                                            <span class="badge bg-info">{{ transaction.account.name }}</span>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="badge {% if transaction.transaction_type == 'income' %}bg-success{% else %}bg-danger{% endif %}">
                                            {{ transaction.transaction_type.title() }}
                                        </span>
                                    </td>
                                    <td class="text-end {% if transaction.transaction_type == 'income' %}text-success{% else %}text-danger{% endif %}">
                                        {% if transaction.transaction_type == 'income' %}+{% else %}-{% endif %}${{ "%.2f"|format(transaction.amount) }}
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary" data-transaction-id="{{ transaction.id }}" onclick="editTransaction(this.dataset.transactionId)">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" data-transaction-id="{{ transaction.id }}" onclick="deleteTransaction(this.dataset.transactionId)">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Pagination would go here in a full implementation -->
                    
                {% else %}
                    <div class="text-center py-5">
                        <i class="bi bi-inbox display-1 text-muted"></i>
                        <h4 class="text-muted mt-3">No transactions found</h4>
                        <p class="text-muted">Add your first transaction to get started!</p>
                        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addTransactionModal">
                            <i class="bi bi-plus-circle"></i> Add Transaction
                        </button>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Add Transaction Modal -->
<div class="modal fade" id="addTransactionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Transaction</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('add_transaction') }}" method="POST">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Transaction Type *</label>
                        <select class="form-select" name="transaction_type" id="transaction_type" required>
                            <option value="">Choose transaction type...</option>
                            <option value="income">ðŸ’° Income</option>
                            <option value="expense">ðŸ’¸ Expense</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Category *</label>
                        <select class="form-select" name="category" id="category_select" required disabled>
                            <option value="">Select transaction type first...</option>
                        </select>
                        <input type="text" class="form-control mt-2" name="custom_category" id="custom_category" 
                               placeholder="Or enter custom category" style="display: none;">
                        <div class="form-check mt-2" style="display: none;" id="custom_category_check">
                            <input class="form-check-input" type="checkbox" id="use_custom" name="use_custom">
                            <label class="form-check-label" for="use_custom">
                                Use custom category
                            </label>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Account</label>
                        <select class="form-select" name="account_id">
                            <option value="">No specific account</option>
                            {% for account in accounts %}
                            <option value="{{ account.id }}">
                                {{ account.name }} 
                                {% if account.bank_name %}({{ account.bank_name }}){% endif %}
                                - ${{ "%.2f"|format(account.current_balance) }}
                            </option>
                            {% endfor %}
                        </select>
                        <small class="text-muted">Optional: Select which account this transaction affects</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Account</label>
                        <select class="form-select" name="account_id">
                            <option value="">No specific account</option>
                            {% for account in accounts %}
                            <option value="{{ account.id }}">
                                {{ account.name }} 
                                {% if account.bank_name %}({{ account.bank_name }}){% endif %}
                                - ${{ "%.2f"|format(account.current_balance) }}
                            </option>
                            {% endfor %}
                        </select>
                        <small class="text-muted">Optional: Select which account this transaction affects</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Amount *</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" class="form-control" name="amount" step="0.01" min="0" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Date *</label>
                        <input type="date" class="form-control" name="date" value="{{ date.today() }}" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <input type="text" class="form-control" name="description" 
                               placeholder="Optional description or note">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-plus-circle"></i> Add Transaction
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function editTransaction(id) {
    // In a full implementation, this would open an edit modal
    alert('Edit functionality would go here for transaction ID: ' + id);
}

function deleteTransaction(id) {
    if (confirm('Are you sure you want to delete this transaction?')) {
        // Create a form and submit it to delete the transaction
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/delete_transaction/${id}`;
        document.body.appendChild(form);
        form.submit();
    }
}

// Define category options
const categoryOptions = {
    income: [
        'Salary',
        'Freelance',
        'Business Income',
        'Investment Returns',
        'Rental Income',
        'Side Hustle',
        'Bonus',
        'Gift',
        'Tax Refund',
        'Other Income'
    ],
    expense: [
        // Housing
        'Housing',
        'Rent',
        'Mortgage',
        'Property Tax',
        'Home Insurance',
        'Home Maintenance',
        
        // Food & Dining
        'Food & Dining',
        'Groceries',
        'Restaurants',
        'Coffee',
        'Takeout',
        
        // Transportation
        'Transportation',
        'Gas',
        'Car Payment',
        'Car Insurance',
        'Public Transit',
        'Uber/Lyft',
        'Car Maintenance',
        
        // Utilities
        'Utilities',
        'Electric',
        'Gas',
        'Water',
        'Internet',
        'Phone',
        'Trash',
        
        // Healthcare
        'Healthcare',
        'Medical',
        'Dental',
        'Pharmacy',
        'Health Insurance',
        'Vision',
        
        // Entertainment
        'Entertainment',
        'Movies',
        'Games',
        'Subscriptions',
        'Hobbies',
        'Sports',
        'Books',
        
        // Shopping
        'Shopping',
        'Clothing',
        'Electronics',
        'Online Shopping',
        'Home Goods',
        
        // Personal Care
        'Personal Care',
        'Beauty',
        'Haircut',
        'Gym',
        'Spa',
        
        // Education
        'Education',
        'Tuition',
        'Books',
        'Courses',
        'Training',
        
        // Insurance
        'Insurance',
        'Life Insurance',
        'Disability Insurance',
        'Umbrella Insurance',
        
        // Other
        'Other'
    ]
};

// Handle transaction type change
document.addEventListener('DOMContentLoaded', function() {
    const transactionTypeSelect = document.getElementById('transaction_type');
    const categorySelect = document.getElementById('category_select');
    const customCategoryInput = document.getElementById('custom_category');
    const customCategoryCheck = document.getElementById('custom_category_check');
    const useCustomCheckbox = document.getElementById('use_custom');
    
    transactionTypeSelect.addEventListener('change', function() {
        const selectedType = this.value;
        
        // Clear and enable category select
        categorySelect.innerHTML = '<option value="">Choose category...</option>';
        
        if (selectedType && categoryOptions[selectedType]) {
            categorySelect.disabled = false;
            
            // Populate category options
            categoryOptions[selectedType].forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                categorySelect.appendChild(option);
            });
            
            // Show custom category option
            customCategoryCheck.style.display = 'block';
        } else {
            categorySelect.disabled = true;
            customCategoryCheck.style.display = 'none';
            customCategoryInput.style.display = 'none';
        }
    });
    
    // Handle custom category checkbox
    useCustomCheckbox.addEventListener('change', function() {
        if (this.checked) {
            customCategoryInput.style.display = 'block';
            categorySelect.disabled = true;
            customCategoryInput.required = true;
            categorySelect.required = false;
        } else {
            customCategoryInput.style.display = 'none';
            categorySelect.disabled = false;
            customCategoryInput.required = false;
            categorySelect.required = true;
        }
    });
});
</script>
{% endblock %}
