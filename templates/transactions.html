{% extends "base.html" %}

{% block title %}Transactions - Personal Finance Tracker{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1><i class="bi bi-list-ul"></i> Transactions</h1>
            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addTransactionModal">
                <i class="bi bi-plus-circle"></i> Add Transaction
            </button>
        </div>
    </div>
</div>

<!-- Filter Form -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Filter Transactions</h5>
            </div>
            <div class="card-body">
                <form method="GET" action="{{ url_for('transactions') }}">
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Category</label>
                            <select class="form-select" name="category">
                                <option value="">All Categories</option>
                                {% for category in categories %}
                                    <option value="{{ category }}" {% if current_filters.category == category %}selected{% endif %}>
                                        {{ category }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Type</label>
                            <select class="form-select" name="type">
                                <option value="">All Types</option>
                                <option value="income" {% if current_filters.type == 'income' %}selected{% endif %}>Income</option>
                                <option value="expense" {% if current_filters.type == 'expense' %}selected{% endif %}>Expense</option>
                            </select>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Start Date</label>
                            <input type="date" class="form-control" name="start_date" value="{{ current_filters.start_date }}">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">End Date</label>
                            <input type="date" class="form-control" name="end_date" value="{{ current_filters.end_date }}">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12">
                            <button type="submit" class="btn btn-primary me-2">
                                <i class="bi bi-funnel"></i> Apply Filters
                            </button>
                            <a href="{{ url_for('transactions') }}" class="btn btn-outline-secondary">
                                <i class="bi bi-x-circle"></i> Clear Filters
                            </a>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Transactions Summary -->
{% if transactions %}
<div class="row mb-4">
    <div class="col-md-4 mb-3">
        <div class="card bg-success text-white">
            <div class="card-body text-center">
                <h6>Total Income (Filtered)</h6>
                <h4>${{ "%.2f"|format(transactions|selectattr('transaction_type', 'equalto', 'income')|map(attribute='amount')|sum) }}</h4>
            </div>
        </div>
    </div>
    <div class="col-md-4 mb-3">
        <div class="card bg-danger text-white">
            <div class="card-body text-center">
                <h6>Total Expenses (Filtered)</h6>
                <h4>${{ "%.2f"|format(transactions|selectattr('transaction_type', 'equalto', 'expense')|map(attribute='amount')|sum) }}</h4>
            </div>
        </div>
    </div>
    <div class="col-md-4 mb-3">
        <div class="card bg-info text-white">
            <div class="card-body text-center">
                <h6>Net (Filtered)</h6>
                <h4>${{ "%.2f"|format(transactions|selectattr('transaction_type', 'equalto', 'income')|map(attribute='amount')|sum - transactions|selectattr('transaction_type', 'equalto', 'expense')|map(attribute='amount')|sum) }}</h4>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Current Month Transactions -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="card-title mb-0">
                    <i class="bi bi-calendar-check"></i> Current Month Transactions
                </h5>
            </div>
            <div class="card-body">
                {% if transactions %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Description</th>
                                    <th>Category</th>
                                    <th>Account</th>
                                    <th>Type</th>
                                    <th class="text-end">Amount</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for transaction in transactions %}
                                <tr>
                                    <td>{{ transaction.date.strftime('%m/%d/%Y') }}</td>
                                    <td>{{ transaction.description or '-' }}</td>
                                    <td><span class="badge bg-secondary">{{ transaction.category }}</span></td>
                                    <td>
                                        {% if transaction.account %}
                                            <span class="badge bg-info">{{ transaction.account.name }}</span>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="badge {% if transaction.transaction_type == 'income' %}bg-success{% else %}bg-danger{% endif %}">
                                            {{ transaction.transaction_type.title() }}
                                        </span>
                                        {% if transaction.transaction_type == 'income' %}
                                            {% if transaction.is_taxable %}
                                                <small class="text-muted ms-1" title="Taxable income">üí∞</small>
                                            {% else %}
                                                <small class="text-warning ms-1" title="Non-taxable income (gift, refund, etc.)">üéÅ</small>
                                            {% endif %}
                                        {% endif %}
                                    </td>
                                    <td class="text-end {% if transaction.transaction_type == 'income' %}text-success{% else %}text-danger{% endif %}">
                                        {% if transaction.transaction_type == 'income' %}+{% else %}-{% endif %}${{ "%.2f"|format(transaction.amount) }}
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary" data-transaction-id="{{ transaction.id }}" onclick="editTransaction(this.dataset.transactionId)">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" data-transaction-id="{{ transaction.id }}" onclick="deleteTransaction(this.dataset.transactionId)">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center py-5">
                        <i class="bi bi-inbox display-1 text-muted"></i>
                        <h4 class="text-muted mt-3">No transactions this month</h4>
                        <p class="text-muted">Add your first transaction to get started!</p>
                        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addTransactionModal">
                            <i class="bi bi-plus-circle"></i> Add Transaction
                        </button>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Past Transactions by Month -->
{% if past_transactions_by_month %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-secondary text-white">
                <h5 class="card-title mb-0">
                    <i class="bi bi-archive"></i> Past Transaction History
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    {% for month_data in past_transactions_by_month %}
                    {% set month_name = month_names[month_data.month - 1] %}
                    {% set year = month_data.year|int %}
                    {% set month = month_data.month|int %}
                    
                    <div class="col-lg-4 col-md-6 mb-3">
                        <div class="card h-100 {% if selected_year == year and selected_month == month %}border-primary{% endif %}">
                            <div class="card-header {% if selected_year == year and selected_month == month %}bg-primary text-white{% else %}bg-light{% endif %}">
                                <h6 class="card-title mb-0">
                                    <i class="bi bi-calendar-month"></i> 
                                    {{ month_name }} {{ year }}
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row text-center">
                                    <div class="col-12 mb-2">
                                        <small class="text-muted">{{ month_data.count }} transactions</small>
                                    </div>
                                </div>
                                <div class="row text-center">
                                    <div class="col-6 mb-2">
                                        <h6 class="text-success mb-1">Income</h6>
                                        <p class="mb-0">${{ "{:,.2f}".format(month_data.total_income or 0) }}</p>
                                        <small class="text-muted">
                                            Taxable: ${{ "{:,.2f}".format(month_data.taxable_income or 0) }}
                                        </small>
                                    </div>
                                    <div class="col-6 mb-2">
                                        <h6 class="text-danger mb-1">Expenses</h6>
                                        <p class="mb-0">${{ "{:,.2f}".format(month_data.total_expenses or 0) }}</p>
                                    </div>
                                </div>
                                <div class="row text-center mt-2">
                                    <div class="col-12">
                                        <h6 class="{% if (month_data.total_income or 0) - (month_data.total_expenses or 0) >= 0 %}text-info{% else %}text-warning{% endif %} mb-1">
                                            Net Balance
                                        </h6>
                                        <p class="mb-0">
                                            ${{ "{:,.2f}".format((month_data.total_income or 0) - (month_data.total_expenses or 0)) }}
                                        </p>
                                    </div>
                                </div>
                                
                                <div class="text-center mt-3">
                                    <a href="{{ url_for('transactions', year=year, month=month) }}" 
                                       class="btn btn-outline-primary btn-sm">
                                        <i class="bi bi-eye"></i> View Details
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                    
                    {% if not past_transactions_by_month %}
                    <div class="col-12">
                        <div class="text-center py-5">
                            <i class="bi bi-calendar-x display-1 text-muted"></i>
                            <h4 class="text-muted mt-3">No past transaction history found</h4>
                            <p class="text-muted">Transaction history will appear here as months pass!</p>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Selected Month Details -->
{% if selected_transactions %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-info text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-list-ul"></i> 
                        {{ month_names[selected_month - 1] }} {{ selected_year }} - Detailed Transactions
                    </h5>
                    <a href="{{ url_for('transactions') }}" class="btn btn-outline-light btn-sm">
                        <i class="bi bi-arrow-left"></i> Back to Overview
                    </a>
                </div>
            </div>
            <div class="card-body">
                <!-- Month Summary -->
                {% set month_income = selected_transactions|selectattr('transaction_type', 'equalto', 'income')|map(attribute='amount')|sum %}
                {% set month_taxable_income = selected_transactions|selectattr('transaction_type', 'equalto', 'income')|selectattr('is_taxable', 'equalto', true)|map(attribute='amount')|sum %}
                {% set month_expenses = selected_transactions|selectattr('transaction_type', 'equalto', 'expense')|map(attribute='amount')|sum %}
                
                <div class="row mb-4">
                    <div class="col-md-3 mb-2">
                        <div class="text-center p-3 bg-success text-white rounded">
                            <h6>Total Income</h6>
                            <h5>${{ "{:,.2f}".format(month_income) }}</h5>
                        </div>
                    </div>
                    <div class="col-md-3 mb-2">
                        <div class="text-center p-3 bg-info text-white rounded">
                            <h6>Taxable Income</h6>
                            <h5>${{ "{:,.2f}".format(month_taxable_income) }}</h5>
                        </div>
                    </div>
                    <div class="col-md-3 mb-2">
                        <div class="text-center p-3 bg-danger text-white rounded">
                            <h6>Total Expenses</h6>
                            <h5>${{ "{:,.2f}".format(month_expenses) }}</h5>
                        </div>
                    </div>
                    <div class="col-md-3 mb-2">
                        <div class="text-center p-3 {% if month_income - month_expenses >= 0 %}bg-primary{% else %}bg-warning{% endif %} text-white rounded">
                            <h6>Net Balance</h6>
                            <h5>${{ "{:,.2f}".format(month_income - month_expenses) }}</h5>
                        </div>
                    </div>
                </div>
                
                <!-- Transactions Table -->
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Description</th>
                                <th>Category</th>
                                <th>Account</th>
                                <th>Type</th>
                                <th class="text-end">Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for transaction in selected_transactions %}
                            <tr>
                                <td>{{ transaction.date.strftime('%m/%d/%Y') }}</td>
                                <td>{{ transaction.description or '-' }}</td>
                                <td>
                                    <span class="badge bg-secondary">{{ transaction.category }}</span>
                                </td>
                                <td>
                                    {% if transaction.account %}
                                        <span class="badge bg-info">{{ transaction.account.name }}</span>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="badge {% if transaction.transaction_type == 'income' %}bg-success{% else %}bg-danger{% endif %}">
                                        {{ transaction.transaction_type.title() }}
                                    </span>
                                    {% if transaction.transaction_type == 'income' %}
                                        {% if transaction.is_taxable %}
                                            <small class="text-muted ms-1" title="Taxable income">üí∞</small>
                                        {% else %}
                                            <small class="text-warning ms-1" title="Non-taxable income (gift, refund, etc.)">üéÅ</small>
                                        {% endif %}
                                    {% endif %}
                                </td>
                                <td class="text-end {% if transaction.transaction_type == 'income' %}text-success{% else %}text-danger{% endif %}">
                                    {% if transaction.transaction_type == 'income' %}+{% else %}-{% endif %}${{ "%.2f"|format(transaction.amount) }}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Add Transaction Modal -->
<div class="modal fade" id="addTransactionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Transaction</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('add_transaction') }}" method="POST">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Transaction Type *</label>
                        <select class="form-select" name="transaction_type" id="transaction_type" required>
                            <option value="">Choose transaction type...</option>
                            <option value="income">üí∞ Income</option>
                            <option value="expense">üí∏ Expense</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Category *</label>
                        <select class="form-select" name="category" id="category_select" required disabled>
                            <option value="">Select transaction type first...</option>
                        </select>
                        <input type="text" class="form-control mt-2" name="custom_category" id="custom_category" 
                               placeholder="Or enter custom category" style="display: none;">
                        <div class="form-check mt-2" style="display: none;" id="custom_category_check">
                            <input class="form-check-input" type="checkbox" id="use_custom" name="use_custom">
                            <label class="form-check-label" for="use_custom">
                                Use custom category
                            </label>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Account</label>
                        <select class="form-select" name="account_id">
                            <option value="">No specific account</option>
                            {% for account in accounts %}
                            <option value="{{ account.id }}">
                                {{ account.name }} 
                                {% if account.bank_name %}({{ account.bank_name }}){% endif %}
                                - ${{ "%.2f"|format(account.current_balance) }}
                            </option>
                            {% endfor %}
                        </select>
                        <small class="text-muted">Optional: Select which account this transaction affects</small>
                    </div>
                    
                    <!-- Taxable Income Checkbox (only shown for income transactions) -->
                    <div class="mb-3" id="taxable_section" style="display: none;">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="is_taxable" name="is_taxable" checked>
                            <label class="form-check-label" for="is_taxable">
                                <strong>This income is taxable</strong>
                            </label>
                        </div>
                        <small class="text-muted">
                            ‚ÑπÔ∏è Uncheck this for gifts, refunds, insurance payouts, inheritances, and other non-taxable income.
                            This affects tax calculations in your budget analysis.
                        </small>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Amount *</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" class="form-control" name="amount" step="0.01" min="0" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Date *</label>
                        <input type="date" class="form-control" name="date" value="{{ date.today() }}" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <input type="text" class="form-control" name="description" 
                               placeholder="Optional description or note">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-plus-circle"></i> Add Transaction
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function editTransaction(id) {
    // In a full implementation, this would open an edit modal
    alert('Edit functionality would go here for transaction ID: ' + id);
}

function deleteTransaction(id) {
    if (confirm('Are you sure you want to delete this transaction?')) {
        // Create a form and submit it to delete the transaction
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/delete_transaction/${id}`;
        document.body.appendChild(form);
        form.submit();
    }
}

// Define category options
const categoryOptions = {
    income: [
        'Salary',
        'Freelance',
        'Business Income',
        'Investment Returns',
        'Rental Income',
        'Side Hustle',
        'Bonus',
        'Gift',
        'Tax Refund',
        'Other Income'
    ],
    expense: [
        // Housing
        'Housing',
        'Rent',
        'Mortgage',
        'Property Tax',
        'Home Insurance',
        'Home Maintenance',
        
        // Food & Dining
        'Food & Dining',
        'Groceries',
        'Restaurants',
        'Coffee',
        'Takeout',
        
        // Transportation
        'Transportation',
        'Gas',
        'Car Payment',
        'Car Insurance',
        'Public Transit',
        'Uber/Lyft',
        'Car Maintenance',
        
        // Utilities
        'Utilities',
        'Electric',
        'Gas',
        'Water',
        'Internet',
        'Phone',
        'Trash',
        
        // Healthcare
        'Healthcare',
        'Medical',
        'Dental',
        'Pharmacy',
        'Health Insurance',
        'Vision',
        
        // Entertainment
        'Entertainment',
        'Movies',
        'Games',
        'Subscriptions',
        'Hobbies',
        'Sports',
        'Books',
        
        // Shopping
        'Shopping',
        'Clothing',
        'Electronics',
        'Online Shopping',
        'Home Goods',
        
        // Personal Care
        'Personal Care',
        'Beauty',
        'Haircut',
        'Gym',
        'Spa',
        
        // Education
        'Education',
        'Tuition',
        'Books',
        'Courses',
        'Training',
        
        // Insurance
        'Insurance',
        'Life Insurance',
        'Disability Insurance',
        'Umbrella Insurance',
        
        // Other
        'Other'
    ]
};

// Handle transaction type change
document.addEventListener('DOMContentLoaded', function() {
    const transactionTypeSelect = document.getElementById('transaction_type');
    const categorySelect = document.getElementById('category_select');
    const customCategoryInput = document.getElementById('custom_category');
    const customCategoryCheck = document.getElementById('custom_category_check');
    const useCustomCheckbox = document.getElementById('use_custom');
    const taxableSection = document.getElementById('taxable_section');
    
    transactionTypeSelect.addEventListener('change', function() {
        const selectedType = this.value;
        
        // Clear and enable category select
        categorySelect.innerHTML = '<option value="">Choose category...</option>';
        
        // Show/hide taxable section based on transaction type
        if (selectedType === 'income') {
            taxableSection.style.display = 'block';
        } else {
            taxableSection.style.display = 'none';
        }
        
        if (selectedType && categoryOptions[selectedType]) {
            categorySelect.disabled = false;
            
            // Populate category options
            categoryOptions[selectedType].forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                categorySelect.appendChild(option);
            });
            
            // Show custom category option
            customCategoryCheck.style.display = 'block';
        } else {
            categorySelect.disabled = true;
            customCategoryCheck.style.display = 'none';
            customCategoryInput.style.display = 'none';
        }
    });
    
    // Handle custom category checkbox
    useCustomCheckbox.addEventListener('change', function() {
        if (this.checked) {
            customCategoryInput.style.display = 'block';
            categorySelect.disabled = true;
            customCategoryInput.required = true;
            categorySelect.required = false;
        } else {
            customCategoryInput.style.display = 'none';
            categorySelect.disabled = false;
            customCategoryInput.required = false;
            categorySelect.required = true;
        }
    });
    
    // Auto-detect non-taxable categories
    const isTaxableCheckbox = document.getElementById('is_taxable');
    const nonTaxableKeywords = ['gift', 'refund', 'insurance', 'inheritance', 'settlement', 'prize', 'lottery', 'gambling', 'transfer', 'loan'];
    
    function checkTaxableStatus() {
        if (transactionTypeSelect.value === 'income') {
            const category = categorySelect.value || customCategoryInput.value || '';
            const categoryLower = category.toLowerCase();
            
            // Check if category suggests non-taxable income
            const isNonTaxable = nonTaxableKeywords.some(keyword => categoryLower.includes(keyword));
            isTaxableCheckbox.checked = !isNonTaxable;
        }
    }
    
    // Add listeners for category changes
    categorySelect.addEventListener('change', checkTaxableStatus);
    customCategoryInput.addEventListener('input', checkTaxableStatus);
});
</script>
{% endblock %}
